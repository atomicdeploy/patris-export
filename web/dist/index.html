<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patris Export - Live Data Viewer</title>
    <style>*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:14px;line-height:1.5}body{background:#f9fafb;color:#111827;transition:background-color .3s ease,color .3s ease}body.dark-mode{background:#111827;color:#f9fafb}.app{display:flex;flex-direction:column;height:100vh}.header{background:#fff;border-bottom:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06)}.dark-mode .header{background:#1f2937;border-bottom-color:#374151}.header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;max-width:100%}.header h1{font-size:1.5rem;font-weight:700;margin:0}.header-actions{display:flex;align-items:center;gap:1rem}.status{display:flex;align-items:center;gap:.5rem;font-size:.875rem}.status-indicator{width:8px;height:8px;border-radius:50%;background:#f59e0b}.status-indicator.connected{background:#10b981;animation:pulse 2s infinite}.status-indicator.disconnected{background:#ef4444}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}.toolbar{background:#fff;border-bottom:1px solid #e5e7eb;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}.dark-mode .toolbar{background:#1f2937;border-bottom-color:#374151}.toolbar-section{display:flex;align-items:center;gap:.75rem}.search-input{padding:.5rem 1rem;border:1px solid #e5e7eb;border-radius:.5rem;font-size:.875rem;min-width:250px;background:#f9fafb;color:#111827}.dark-mode .search-input{background:#111827;color:#f9fafb;border-color:#374151}.search-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.1)}.field-select,.select-input{padding:.5rem 1rem;border:1px solid #e5e7eb;border-radius:.5rem;font-size:.875rem;background:#f9fafb;color:#111827;cursor:pointer}.dark-mode .field-select,.dark-mode .select-input{background:#111827;color:#f9fafb;border-color:#374151}.record-count{font-size:.875rem;color:#6b7280}.dark-mode .record-count{color:#d1d5db}.record-count strong{color:#111827;font-weight:600}.dark-mode .record-count strong{color:#f9fafb}.main-content{flex:1;overflow:hidden;padding:1.5rem}.table-container{height:100%;background:#fff;border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);overflow:auto;position:relative}.dark-mode .table-container{background:#1f2937}.data-table{width:100%;border-collapse:collapse;font-size:.875rem}.data-table thead{position:sticky;top:0;background:#f3f4f6;z-index:10}.dark-mode .data-table thead{background:#374151}.data-table th{padding:.875rem 1rem;text-align:left;font-weight:600;border-bottom:2px solid #e5e7eb;white-space:nowrap}.dark-mode .data-table th{border-bottom-color:#374151}.data-table td{padding:.875rem 1rem;border-bottom:1px solid #e5e7eb}.dark-mode .data-table td{border-bottom-color:#374151}.data-table tbody tr{transition:background-color .15s ease;cursor:pointer}.data-table tbody tr:hover{background:#f9fafb}.dark-mode .data-table tbody tr:hover{background:#111827}.data-table tbody tr.changed{animation:highlight 2s ease-out}@keyframes highlight{0%{background-color:rgba(99,102,241,.3)}100%{background-color:rgba(0,0,0,0)}}.btn{padding:.5rem 1rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .15s ease;background:#f3f4f6;color:#111827}.dark-mode .btn{background:#374151;color:#f9fafb}.btn:hover{opacity:.8}.btn:active{transform:scale(0.98)}.btn-icon{padding:.5rem;background:rgba(0,0,0,0);font-size:1.25rem}.btn-primary{background:#6366f1;color:#fff}.btn-primary:hover{background:#4f46e5;opacity:1}.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:1rem}.spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}.dark-mode .spinner{border-color:#374151;border-top-color:#6366f1}@keyframes spin{to{transform:rotate(360deg)}}.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:1rem;color:#6b7280}.dark-mode .empty-state{color:#d1d5db}.empty-icon{font-size:4rem}.settings-panel{position:fixed;top:0;right:-400px;width:400px;height:100vh;background:#fff;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);transition:right .3s ease;z-index:1000}.dark-mode .settings-panel{background:#1f2937}.settings-panel.open{right:0}.settings-content{padding:2rem;height:100%;overflow-y:auto}.settings-content h2{margin-bottom:1.5rem;font-size:1.5rem}.settings-group{margin-bottom:1.5rem}.settings-group label{display:block;margin-bottom:.5rem;font-weight:500}.checkbox-label{display:flex;align-items:center;gap:.5rem;padding:.75rem;margin-bottom:.5rem;border-radius:.5rem;cursor:pointer}.checkbox-label:hover{background:#f9fafb}.dark-mode .checkbox-label:hover{background:#111827}.checkbox-label input[type=checkbox]{width:18px;height:18px;cursor:pointer}.inspector-panel{position:fixed;bottom:-50vh;left:0;right:0;height:50vh;background:#fff;box-shadow:0 -4px 6px rgba(0,0,0,.1);transition:bottom .3s ease;z-index:1000}.dark-mode .inspector-panel{background:#1f2937}.inspector-panel.open{bottom:0}.inspector-content{height:100%;display:flex;flex-direction:column}.inspector-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb}.dark-mode .inspector-header{border-bottom-color:#374151}.inspector-header h2{font-size:1.25rem;margin:0}.inspector-body{flex:1;overflow-y:auto;padding:1.5rem}.inspector-field{display:grid;grid-template-columns:200px 1fr;gap:1rem;padding:.75rem;border-bottom:1px solid #e5e7eb}.dark-mode .inspector-field{border-bottom-color:#374151}.inspector-field:last-child{border-bottom:none}.inspector-field-name{font-weight:600;color:#6b7280}.dark-mode .inspector-field-name{color:#d1d5db}.inspector-field-value{word-break:break-word;font-family:"Courier New",monospace}.text-muted{color:#6b7280}.dark-mode .text-muted{color:#d1d5db}.action-cell{display:flex;gap:.5rem}.action-btn{padding:.25rem .5rem;font-size:.75rem;background:rgba(0,0,0,0);border:1px solid #e5e7eb;border-radius:.25rem;cursor:pointer;transition:all .15s ease;color:#111827}.dark-mode .action-btn{border-color:#374151;color:#f9fafb}.action-btn:hover{background:#6366f1;color:#fff;border-color:#6366f1}@media(max-width: 768px){.header-content{flex-direction:column;gap:1rem;align-items:flex-start}.toolbar{flex-direction:column;align-items:stretch}.toolbar-section{flex-direction:column;align-items:stretch}.search-input{min-width:100%}.settings-panel{width:100%;right:-100%}.inspector-panel{height:70vh;bottom:-70vh}.data-table{font-size:.75rem}.data-table th,.data-table td{padding:.5rem}}</style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <h1>üìä Patris Export</h1>
                <div class="header-actions">
                    <div class="status">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">Connecting...</span>
                    </div>
                    <button class="btn btn-icon" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
                    <button class="btn btn-icon" id="themeToggle" title="Toggle Theme">üåô</button>
                </div>
            </div>
        </header>

        <div class="toolbar">
            <div class="toolbar-section">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Search records...">
                <select id="fieldFilter" class="field-select">
                    <option value="">All Fields</option>
                </select>
            </div>
            <div class="toolbar-section">
                <div class="record-count">
                    Total: <strong id="totalCount">0</strong> | 
                    Filtered: <strong id="filteredCount">0</strong>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="table-container">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Loading data...</p>
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <p>No records found</p>
                </div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="settings-content">
                <h2>Settings</h2>
                <div class="settings-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoScrollToChanged">
                        <span>Auto-scroll to changed items</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="highlightChanges" checked>
                        <span>Highlight changed items</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="enablePagination">
                        <span>Enable pagination</span>
                    </label>
                </div>
                <div class="settings-group">
                    <label>
                        Records per page:
                        <select id="pageSize" class="select-input">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="500">500</option>
                        </select>
                    </label>
                </div>
                <button class="btn btn-primary" id="closeSettings">Close</button>
            </div>
        </div>

        <div class="inspector-panel" id="inspectorPanel">
            <div class="inspector-content">
                <div class="inspector-header">
                    <h2>Record Inspector</h2>
                    <button class="btn btn-icon" id="closeInspector">‚úï</button>
                </div>
                <div class="inspector-body" id="inspectorBody">
                    <p class="text-muted">Select a record to inspect</p>
                </div>
            </div>
        </div>
    </div>
    <script>(()=>{var e={records:[],filteredRecords:[],fields:[],ws:null,searchTerm:"",selectedField:"",settings:{autoScrollToChanged:!1,highlightChanges:!0,enablePagination:!1,pageSize:100}};function T(){let t=localStorage.getItem("patris-settings");t&&(e.settings={...e.settings,...JSON.parse(t)})}function g(){localStorage.setItem("patris-settings",JSON.stringify(e.settings))}function L(){document.getElementById("autoScrollToChanged").checked=e.settings.autoScrollToChanged,document.getElementById("highlightChanges").checked=e.settings.highlightChanges,document.getElementById("enablePagination").checked=e.settings.enablePagination,document.getElementById("pageSize").value=e.settings.pageSize}function B(){let n=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;e.ws=new WebSocket(n),e.ws.onopen=()=>{console.log("WebSocket connected"),y("connected","Connected")},e.ws.onmessage=s=>{try{let o=JSON.parse(s.data);x(o)}catch(o){console.error("Failed to parse WebSocket message:",o)}},e.ws.onerror=s=>{console.error("WebSocket error:",s),y("disconnected","Error")},e.ws.onclose=()=>{console.log("WebSocket disconnected"),y("disconnected","Disconnected"),setTimeout(B,3e3)}}function E(t){let n={},s=[],o=0;for(let[d,c]of Object.entries(t)){if(d.startsWith("Sort"))continue;if(d==="ALLANBAR"){n[d]=c;continue}let a=d.match(/^ANBAR(\d+)$/);if(a){let i=parseInt(a[1]);s[i-1]=c,i>o&&(o=i);continue}n[d]=c}if(o>0){let d=[];for(let c=0;c<o;c++)d.push(s[c]!==void 0?s[c]:0);n.ANBAR=d}return n}function x(t){let n=new Set;if(t.type==="initial")e.records=(t.added||[]).map(E),e.settings.highlightChanges&&e.records.forEach((s,o)=>n.add(o));else if(t.type==="update"){if(t.deleted&&t.deleted.length>0&&[...t.deleted].sort((o,d)=>d-o).forEach(o=>{o>=0&&o<e.records.length&&e.records.splice(o,1)}),t.added&&t.added.length>0){let s=e.records.length,o=t.added.map(E);e.records.push(...o),o.forEach((d,c)=>{n.add(s+c)})}t.modified&&t.modified.length>0&&t.modified.forEach(s=>{let o=E(s),d=JSON.stringify(o),c=e.records.findIndex(a=>JSON.stringify(a)===d);c!==-1&&(e.records[c]=o,n.add(c))})}e.records.length>0&&e.fields.length===0&&(e.fields=Object.keys(e.records[0]),b(),k()),m(),l(n),u()}function y(t,n){let s=document.getElementById("statusIndicator"),o=document.getElementById("statusText");s.className="status-indicator "+t,o.textContent=n}function b(){let t=document.getElementById("tableHead"),n=document.createElement("tr");e.fields.forEach(o=>{let d=document.createElement("th");d.textContent=o,n.appendChild(d)});let s=document.createElement("th");s.textContent="Actions",s.style.width="100px",n.appendChild(s),t.innerHTML="",t.appendChild(n)}function l(t=new Set){let n=document.getElementById("tableBody"),s=document.getElementById("loading"),o=document.getElementById("emptyState");if(s.style.display="none",e.filteredRecords.length===0){n.innerHTML="",o.style.display="flex";return}o.style.display="none";let d=e.settings.enablePagination?e.filteredRecords.slice(0,e.settings.pageSize):e.filteredRecords;n.innerHTML="",d.forEach((c,a)=>{let i=document.createElement("tr"),I=e.records.indexOf(c);t.has(I)&&e.settings.highlightChanges&&(i.classList.add("changed"),e.settings.autoScrollToChanged&&I===Math.min(...t)&&setTimeout(()=>{i.scrollIntoView({behavior:"smooth",block:"center"})},100)),e.fields.forEach(f=>{let C=document.createElement("td"),p=c[f];C.textContent=p??"",i.appendChild(C)});let h=document.createElement("td");h.className="action-cell";let r=document.createElement("button");r.className="action-btn",r.textContent="\u{1F50D} Inspect",r.onclick=f=>{f.stopPropagation(),S(c)},h.appendChild(r),i.appendChild(h),i.onclick=()=>S(c),n.appendChild(i)})}function m(){if(!e.searchTerm&&!e.selectedField){e.filteredRecords=e.records;return}e.filteredRecords=e.records.filter(t=>{if(e.selectedField&&!t[e.selectedField])return!1;if(e.searchTerm){let n=e.searchTerm.toLowerCase();return e.fields.some(s=>{let o=t[s];return o==null?!1:String(o).toLowerCase().includes(n)})}return!0})}function k(){let t=document.getElementById("fieldFilter");t.innerHTML='<option value="">All Fields</option>',e.fields.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,t.appendChild(s)})}function u(){document.getElementById("totalCount").textContent=e.records.length,document.getElementById("filteredCount").textContent=e.filteredRecords.length}function S(t){let n=document.getElementById("inspectorPanel"),s=document.getElementById("inspectorBody");s.innerHTML="",e.fields.forEach(o=>{let d=document.createElement("div");d.className="inspector-field";let c=document.createElement("div");c.className="inspector-field-name",c.textContent=o;let a=document.createElement("div");a.className="inspector-field-value";let i=t[o];a.textContent=i!=null?String(i):"(null)",d.appendChild(c),d.appendChild(a),s.appendChild(d)}),n.classList.add("open")}function N(){let t=document.body.classList.toggle("dark-mode");localStorage.setItem("theme",t?"dark":"light"),w(t)}function w(t){let n=document.getElementById("themeToggle");n.textContent=t?"\u2600\uFE0F":"\u{1F319}"}function R(){let t=localStorage.getItem("theme"),n=window.matchMedia("(prefers-color-scheme: dark)").matches,s=t==="dark"||!t&&n;s&&document.body.classList.add("dark-mode"),w(s)}function v(){T(),L(),R(),document.getElementById("searchInput").addEventListener("input",t=>{e.searchTerm=t.target.value,m(),l(),u()}),document.getElementById("fieldFilter").addEventListener("change",t=>{e.selectedField=t.target.value,m(),l(),u()}),document.getElementById("themeToggle").addEventListener("click",N),document.getElementById("settingsBtn").addEventListener("click",()=>{document.getElementById("settingsPanel").classList.toggle("open")}),document.getElementById("closeSettings").addEventListener("click",()=>{document.getElementById("settingsPanel").classList.remove("open")}),document.getElementById("closeInspector").addEventListener("click",()=>{document.getElementById("inspectorPanel").classList.remove("open")}),document.getElementById("autoScrollToChanged").addEventListener("change",t=>{e.settings.autoScrollToChanged=t.target.checked,g()}),document.getElementById("highlightChanges").addEventListener("change",t=>{e.settings.highlightChanges=t.target.checked,g()}),document.getElementById("enablePagination").addEventListener("change",t=>{e.settings.enablePagination=t.target.checked,g(),l()}),document.getElementById("pageSize").addEventListener("change",t=>{e.settings.pageSize=parseInt(t.target.value),g(),e.settings.enablePagination&&l()}),B(),F()}async function F(){try{let t=await fetch("/api/records");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let n=await t.json();n.success&&n.records&&(e.records=Object.values(n.records),e.records.length>0&&(e.fields=Object.keys(e.records[0]),b(),k()),m(),l(),u())}catch(t){console.error("Failed to fetch initial data:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",v):v();})();
</script>
</body>
</html>
