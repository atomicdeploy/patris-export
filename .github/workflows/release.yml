name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for build workflows
      uses: actions/github-script@v7
      with:
        script: |
          // Wait for the build workflows to complete
          const workflows = ['build.yml', 'build-windows.yml'];
          const sha = context.sha;
          
          for (const workflow of workflows) {
            console.log(`Checking workflow: ${workflow}`);
            
            // Poll for workflow runs
            let completed = false;
            for (let i = 0; i < 30; i++) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow,
                head_sha: sha
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`Run status: ${run.status}, conclusion: ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    completed = true;
                    break;
                  } else {
                    throw new Error(`Workflow ${workflow} failed with conclusion: ${run.conclusion}`);
                  }
                }
              }
              
              // Wait 10 seconds before checking again
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
            
            if (!completed) {
              throw new Error(`Workflow ${workflow} did not complete in time`);
            }
          }
      
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-linux-amd64
        path: ./artifacts
        
    - name: Download Windows MSVC artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-windows-msvc-amd64
        path: ./artifacts
        
    - name: Download Windows MinGW artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-windows-mingw-amd64
        path: ./artifacts-cross
      continue-on-error: true
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/patris-export-linux-amd64
          artifacts/patris-export-windows-amd64.exe
          artifacts/*.dll
          artifacts-cross/patris-export-windows-amd64.exe
          artifacts-cross/*.dll
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
