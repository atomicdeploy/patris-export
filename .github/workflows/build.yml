name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pxlib-dev pxlib1
        
    - name: Build
      run: make build-linux
      
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: patris-export-linux-amd64
        path: build/patris-export-linux-amd64

  build-windows:
    name: Build for Windows
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Build pxlib for Windows
      run: |
        cd /tmp
        git clone https://github.com/DRSDavidSoft/pxlib.git
        cd pxlib
        git checkout copilot/ensure-windows-build-success
        mkdir build
        cd build
        cmake .. -DCMAKE_SYSTEM_NAME=Windows -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        # Install headers and library
        sudo mkdir -p /usr/x86_64-w64-mingw32/include
        sudo cp ../include/paradox.h.in /usr/x86_64-w64-mingw32/include/paradox.h
        sudo cp ../include/paradox-gsf.h /usr/x86_64-w64-mingw32/include/ || true
        sudo cp ../include/paradox-mp.h /usr/x86_64-w64-mingw32/include/
        sudo cp config.h /usr/x86_64-w64-mingw32/include/ || true
        sudo cp include/paradox.h /usr/x86_64-w64-mingw32/include/paradox.h || true
        sudo cp libpxlib.dll.a /usr/x86_64-w64-mingw32/lib/libpx.a || true
        sudo cp libpxlib.a /usr/x86_64-w64-mingw32/lib/libpx.a || true
        find . -name "*.dll.a" -exec sudo cp {} /usr/x86_64-w64-mingw32/lib/libpx.a \; || true
        find . -name "*.a" -exec sudo cp {} /usr/x86_64-w64-mingw32/lib/libpx.a \; || true
        ls -la /usr/x86_64-w64-mingw32/lib/
        ls -la /usr/x86_64-w64-mingw32/include/
        
    - name: Build Windows executable
      run: |
        CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CC=x86_64-w64-mingw32-gcc go build -ldflags "-X main.Version=1.0.0 -X main.BuildDate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" -o build/patris-export-windows-amd64.exe ./cmd/patris-export
      
    - name: Copy pxlib DLL
      run: |
        find /tmp/pxlib/build -name "*.dll" -exec cp {} build/ \;
        ls -la build/
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: patris-export-windows-amd64
        path: |
          build/patris-export-windows-amd64.exe
          build/*.dll
        
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pxlib-dev pxlib1
        
    - name: Run tests
      run: go test -v ./...
      
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-linux-amd64
        path: ./artifacts
        
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-windows-amd64
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/patris-export-linux-amd64
          artifacts/patris-export-windows-amd64.exe
          artifacts/*.dll
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
