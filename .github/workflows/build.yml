name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pxlib-dev pxlib1
        
    - name: Build
      run: make build-linux
      
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: patris-export-linux-amd64
        path: build/patris-export-linux-amd64

  build-windows:
    name: Build for Windows
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake

    - name: Build pxlib for Windows
      run: |
        cd /tmp
        git clone https://github.com/DRSDavidSoft/pxlib.git
        cd pxlib
        git checkout copilot/ensure-windows-build-success
        mkdir build
        cd build
        
        # Configure with CMake for Windows cross-compilation
        cmake .. \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
          -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_FIND_ROOT_PATH=/usr/x86_64-w64-mingw32 \
          -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY
        
        # Build the library
        cmake --build . --config Release
        
        # Install headers
        sudo mkdir -p /usr/x86_64-w64-mingw32/include
        # Use the generated paradox.h from the build directory
        if [ -f include/paradox.h ]; then
          sudo cp include/paradox.h /usr/x86_64-w64-mingw32/include/
        elif [ -f ../include/paradox.h.in ]; then
          # If not generated, manually configure it
          sed 's/@PX_HAVE_ICONV@/1/g; s/@PX_HAVE_RECODE@/0/g; s/@PX_HAVE_GSF@/0/g' \
            ../include/paradox.h.in | sudo tee /usr/x86_64-w64-mingw32/include/paradox.h > /dev/null
        fi
        
        # Copy additional headers
        [ -f ../include/paradox-mp.h ] && sudo cp ../include/paradox-mp.h /usr/x86_64-w64-mingw32/include/ || true
        [ -f config.h ] && sudo cp config.h /usr/x86_64-w64-mingw32/include/ || true
        
        # Install library files
        # Find and copy the static library
        if [ -f libpxlib.a ]; then
          sudo cp libpxlib.a /usr/x86_64-w64-mingw32/lib/libpx.a
        elif [ -f libpxlib.dll.a ]; then
          sudo cp libpxlib.dll.a /usr/x86_64-w64-mingw32/lib/libpx.a
        else
          # Search in subdirectories
          find . -name "libpxlib*.a" -o -name "pxlib*.a" | head -1 | xargs -I {} sudo cp {} /usr/x86_64-w64-mingw32/lib/libpx.a || true
        fi
        
        echo "Installed headers:"
        ls -la /usr/x86_64-w64-mingw32/include/paradox* || echo "No paradox headers found"
        echo "Installed libraries:"
        ls -la /usr/x86_64-w64-mingw32/lib/libpx* || echo "No pxlib libraries found"
        
    - name: Build Windows executable
      run: |
        mkdir -p build
        CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CC=x86_64-w64-mingw32-gcc \
          CGO_LDFLAGS="-L/usr/x86_64-w64-mingw32/lib" \
          CGO_CFLAGS="-I/usr/x86_64-w64-mingw32/include" \
          go build -ldflags "-X main.Version=1.0.0 -X main.BuildDate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          -o build/patris-export-windows-amd64.exe ./cmd/patris-export
      
    - name: Copy pxlib DLL
      run: |
        # Find and copy DLL files
        mkdir -p build
        if find /tmp/pxlib/build -name "*.dll" -type f 2>/dev/null | grep -q .; then
          find /tmp/pxlib/build -name "*.dll" -type f -exec cp {} build/ \;
          echo "DLL files copied:"
          ls -la build/*.dll
        else
          echo "Warning: No DLL files found - Windows executable may require runtime linking"
        fi
        echo "Build directory contents:"
        ls -la build/
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: patris-export-windows-amd64
        path: |
          build/patris-export-windows-amd64.exe
          build/*.dll
        
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pxlib-dev pxlib1
        
    - name: Run tests
      run: go test -v ./...
      
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-linux-amd64
        path: ./artifacts
        
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: patris-export-windows-amd64
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/patris-export-linux-amd64
          artifacts/patris-export-windows-amd64.exe
          artifacts/*.dll
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
