name: Build

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pxlib-dev pxlib1
        
    - name: Build
      run: make build-linux
      
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      id: upload-linux
      with:
        name: patris-export-linux-amd64
        path: build/patris-export-linux-amd64
    
    - name: Generate build summary
      run: |
        echo "# ðŸ§ Linux Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get build details
        BUILD_FILE="build/patris-export-linux-amd64"
        FILE_SIZE=$(stat -c%s "$BUILD_FILE")
        FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1048576" | bc)
        SHA256=$(sha256sum "$BUILD_FILE" | awk '{print $1}')
        BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        # Calculate artifact expiration (90 days from now by default)
        EXPIRY_DATE=$(date -u -d "+90 days" +'%Y-%m-%d')
        
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“„ Executable | \`patris-export-linux-amd64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build Date | $BUILD_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¢ Version | \`1.0.0\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ File Size | $FILE_SIZE_MB MB ($FILE_SIZE bytes) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” SHA-256 Hash | \`$SHA256\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Artifact Name | \`patris-export-linux-amd64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¥ Download URL | [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| â° Expires On | $EXPIRY_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY

  build-windows-mingw-cross:
    name: Build for Windows (MinGW cross-compile from Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 mingw-w64-tools gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 cmake
        
        # Verify MinGW installation
        echo "Checking MinGW installation..."
        x86_64-w64-mingw32-gcc --version
        ls -la /usr/share/mingw-w64/include/ 2>/dev/null || echo "MinGW headers not in standard location"

    - name: Generate version resource file
      run: |
        ${GITHUB_WORKSPACE}/scripts/generate-version-rc.sh cmd/patris-export/patris-export.rc
        
    - name: Build pxlib for Windows
      run: |
        cd /tmp
        git clone https://github.com/steinm/pxlib.git
        cd pxlib
        
        # Fix case-sensitive Windows.h include for case-sensitive filesystems
        # MinGW uses lowercase windows.h
        sed -i 's/#include <Windows\.h>/#include <windows.h>/g' src/paradox.c
        sed -i 's/#include <Winbase\.h>/#include <winbase.h>/g' src/paradox.c
        
        # Patch CMakeLists.txt to fix windres compilation
        ${GITHUB_WORKSPACE}/scripts/patch-pxlib-cmake.sh /tmp/pxlib
        
        # Create a CMake toolchain file for MinGW cross-compilation
        cat > mingw-toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Windows)
        set(CMAKE_SYSTEM_PROCESSOR x86_64)
        
        set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
        set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
        set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)
        
        set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        EOF
        
        mkdir build
        cd build
        
        # Configure with CMake using the toolchain file
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../mingw-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_GSF=OFF
        
        # Build the library
        cmake --build . --config Release -- -j$(nproc) || {
          echo "Build failed, trying with verbose output..."
          cmake --build . --config Release --verbose
        }
        
        # Install headers
        sudo mkdir -p /usr/x86_64-w64-mingw32/include
        # Use the generated paradox.h from the build directory
        if [ -f include/paradox.h ]; then
          sudo cp include/paradox.h /usr/x86_64-w64-mingw32/include/
        elif [ -f ../include/paradox.h.in ]; then
          # If not generated, manually configure it
          sed 's/@PX_HAVE_ICONV@/1/g; s/@PX_HAVE_RECODE@/0/g; s/@PX_HAVE_GSF@/0/g' \
            ../include/paradox.h.in | sudo tee /usr/x86_64-w64-mingw32/include/paradox.h > /dev/null
        fi
        
        # Copy additional headers
        [ -f ../include/paradox-mp.h ] && sudo cp ../include/paradox-mp.h /usr/x86_64-w64-mingw32/include/ || true
        [ -f config.h ] && sudo cp config.h /usr/x86_64-w64-mingw32/include/ || true
        
        # Install library files
        # Find and copy the static library (keep original name - CGO now uses -lpxlib)
        if [ -f libpxlib.a ]; then
          sudo cp libpxlib.a /usr/x86_64-w64-mingw32/lib/
          echo "Installed libpxlib.a"
        elif [ -f libpxlib.dll.a ]; then
          sudo cp libpxlib.dll.a /usr/x86_64-w64-mingw32/lib/
          echo "Installed libpxlib.dll.a"
        else
          # Search in subdirectories
          LIBFILE=$(find . -name "libpxlib*.a" -o -name "pxlib*.a" | head -1)
          if [ -n "$LIBFILE" ]; then
            sudo cp "$LIBFILE" /usr/x86_64-w64-mingw32/lib/
            echo "Installed $LIBFILE"
          else
            echo "ERROR: No pxlib library file found!"
            find . -name "*.a" -o -name "*.dll"
            exit 1
          fi
        fi
        
        echo "Installed headers:"
        ls -la /usr/x86_64-w64-mingw32/include/paradox* || echo "No paradox headers found"
        echo "Installed libraries:"
        ls -la /usr/x86_64-w64-mingw32/lib/libpxlib* || echo "No pxlib libraries found"
    
    - name: Compile resource file for patris-export
      run: |
        # Compile the Windows resource file to .syso for embedding
        echo "Compiling Windows resource file..."
        x86_64-w64-mingw32-windres \
          -i cmd/patris-export/patris-export.rc \
          -o cmd/patris-export/patris-export_windows_amd64.syso \
          -O coff \
          --target=pe-x86-64
        
        echo "Resource file compiled successfully:"
        ls -lh cmd/patris-export/patris-export_windows_amd64.syso
        
    - name: Build Windows executable
      run: |
        mkdir -p build
        CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CC=x86_64-w64-mingw32-gcc \
          CGO_LDFLAGS="-L/usr/x86_64-w64-mingw32/lib" \
          CGO_CFLAGS="-I/usr/x86_64-w64-mingw32/include" \
          go build -ldflags "-X main.Version=1.0.0 -X main.BuildDate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          -o build/patris-export-windows-amd64.exe ./cmd/patris-export
      
    - name: Copy pxlib DLL
      run: |
        # Find and copy DLL files
        mkdir -p build
        if find /tmp/pxlib/build -name "*.dll" -type f 2>/dev/null | grep -q .; then
          find /tmp/pxlib/build -name "*.dll" -type f -exec cp {} build/ \;
          echo "DLL files copied:"
          ls -la build/*.dll
        else
          echo "Warning: No DLL files found - Windows executable may require runtime linking"
        fi
        echo "Build directory contents:"
        ls -la build/
    
    - name: Test Windows executable with Wine
      run: |
        # Install Wine to test Windows executable on Linux
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y wine wine64 wine32
        
        # Test the Windows executable can read the test database
        cd build
        echo "Testing Windows executable with kala.db..."
        wine patris-export-windows-amd64.exe info ../testdata/kala.db || {
          echo "ERROR: Windows executable failed to read database!"
          echo "This indicates the build is not working correctly."
          exit 1
        }
        
        # Verify it reports the correct number of records (use sed for portability, avoid grep -P locale issues)
        RECORD_COUNT=$(wine patris-export-windows-amd64.exe info ../testdata/kala.db 2>/dev/null | grep 'Records:' | sed 's/.*Records:[[:space:]]*\([0-9]*\).*/\1/' || echo "0")
        echo "Windows build reports $RECORD_COUNT records"
        if [ "$RECORD_COUNT" -eq "0" ]; then
          echo "ERROR: Windows build reports 0 records - CGO/pxlib not working!"
          exit 1
        elif [ "$RECORD_COUNT" -ne "354" ]; then
          echo "WARNING: Expected 354 records but got $RECORD_COUNT"
          exit 1
        else
          echo "âœ… Windows build correctly reports 354 records"
        fi
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      id: upload-windows
      with:
        name: patris-export-windows-mingw-cross-amd64
        path: |
          build/patris-export-windows-amd64.exe
          build/*.dll
    
    - name: Generate build summary
      run: |
        echo "# ðŸªŸ Windows Build Summary (MinGW Cross-Compile)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get build details for executable
        EXE_FILE="build/patris-export-windows-amd64.exe"
        EXE_SIZE=$(stat -c%s "$EXE_FILE")
        EXE_SIZE_MB=$(echo "scale=2; $EXE_SIZE / 1048576" | bc)
        EXE_SHA256=$(sha256sum "$EXE_FILE" | awk '{print $1}')
        BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        # Calculate artifact expiration (90 days from now by default)
        EXPIRY_DATE=$(date -u -d "+90 days" +'%Y-%m-%d')
        
        echo "### ðŸŽ¯ Main Executable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“„ Executable | \`patris-export-windows-amd64.exe\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build Date | $BUILD_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¢ Version | \`1.0.0\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ File Size | $EXE_SIZE_MB MB ($EXE_SIZE bytes) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” SHA-256 Hash | \`$EXE_SHA256\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List DLL files if any
        if ls build/*.dll 1> /dev/null 2>&1; then
          echo "### ðŸ“š Included DLL Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | SHA-256 Hash |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------------|" >> $GITHUB_STEP_SUMMARY
          
          for dll in build/*.dll; do
            if [ -f "$dll" ]; then
              DLL_NAME=$(basename "$dll")
              DLL_SIZE=$(stat -c%s "$dll")
              DLL_SIZE_KB=$(echo "scale=2; $DLL_SIZE / 1024" | bc)
              DLL_SHA256=$(sha256sum "$dll" | awk '{print $1}')
              echo "| \`$DLL_NAME\` | ${DLL_SIZE_KB} KB | \`$DLL_SHA256\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Calculate total artifact size
        TOTAL_SIZE=$(du -sb build/*.exe build/*.dll 2>/dev/null | awk '{sum+=$1} END {print sum}')
        TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1048576" | bc)
        
        echo "### ðŸ“¦ Artifact Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Artifact Name | \`patris-export-windows-mingw-cross-amd64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total Artifact Size | $TOTAL_SIZE_MB MB ($TOTAL_SIZE bytes) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¥ Download URL | [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| â° Expires On | $EXPIRY_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY
