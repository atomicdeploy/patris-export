name: Build Windows MinGW

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-windows-mingw:
    name: Build on Windows (MinGW)
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Install vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        
    - name: Install dependencies via vcpkg
      run: |
        # Try to install pxlib if available in vcpkg, otherwise build from source
        C:\vcpkg\vcpkg search pxlib || echo "pxlib not in vcpkg, will build from source"
        
    - name: Install CMake and build tools
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install mingw -y
        refreshenv
    
    - name: Generate version resource file
      shell: bash
      run: |
        ${GITHUB_WORKSPACE}/scripts/generate-version-rc.sh cmd/patris-export/patris-export.rc
        
    - name: Build pxlib for Windows
      shell: bash
      run: |
        cd /c/
        git clone https://github.com/steinm/pxlib.git
        cd pxlib
        
        # Patch CMakeLists.txt to fix windres compilation
        ${GITHUB_WORKSPACE}/scripts/patch-pxlib-cmake.sh /c/pxlib
        
        mkdir build
        cd build
        
        # Configure with CMake
        cmake .. -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_GSF=OFF
        
        # Build the library
        cmake --build . --config Release
        
        # Install for use by Go
        cmake --install . --prefix C:/pxlib-install
        
        # Verify installation worked, if not do manual install
        if [ ! -f "C:/pxlib-install/include/paradox.h" ]; then
          echo "CMake install did not install files, performing manual install..."
          mkdir -p C:/pxlib-install/include
          mkdir -p C:/pxlib-install/lib
          mkdir -p C:/pxlib-install/bin
          
          # Copy headers
          echo "Copying headers..."
          cp -v ../include/*.h C:/pxlib-install/include/ || echo "Warning: Failed to copy headers from ../include"
          cp -v include/*.h C:/pxlib-install/include/ 2>/dev/null || echo "Warning: No headers in build/include"
          
          # Copy DLLs - look in common build locations
          echo "Copying DLLs..."
          cp -v *.dll C:/pxlib-install/bin/ 2>/dev/null || echo "No DLLs in current directory"
          cp -v Release/*.dll C:/pxlib-install/bin/ 2>/dev/null || echo "No DLLs in Release/"
          cp -v libpxlib.dll C:/pxlib-install/bin/ 2>/dev/null || echo "No libpxlib.dll"
          
          # Copy import libraries
          echo "Copying import libraries..."
          cp -v *.a C:/pxlib-install/lib/ 2>/dev/null || echo "No .a files"
          cp -v *.lib C:/pxlib-install/lib/ 2>/dev/null || echo "No .lib files"
          cp -v Release/*.a C:/pxlib-install/lib/ 2>/dev/null || echo "No .a in Release/"
          cp -v Release/*.lib C:/pxlib-install/lib/ 2>/dev/null || echo "No .lib in Release/"
        fi
        
        echo "Installed files:"
        ls -la C:/pxlib-install/include/ || echo "No headers installed"
        ls -la C:/pxlib-install/lib/ || echo "No libraries installed"
        ls -la C:/pxlib-install/bin/ || echo "No DLLs installed"
        
        # Verify critical files exist
        if [ ! -f "C:/pxlib-install/include/paradox.h" ]; then
          echo "ERROR: paradox.h not found! Listing build directory contents:"
          find . -name "paradox.h" || echo "paradox.h not found anywhere in build directory"
          find ../include -name "*.h" || echo "No headers in ../include"
          exit 1
        fi
        
        echo "pxlib installation verified successfully"
    
    - name: Compile resource file for patris-export
      shell: bash
      run: |
        # Use windres to compile the resource file
        echo "Compiling Windows resource file..."
        
        # Find windres (could be in MinGW or MSYS paths)
        WINDRES=$(which windres || which x86_64-w64-mingw32-windres || echo "C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/windres.exe")
        
        if [ ! -f "$WINDRES" ]; then
          echo "Searching for windres..."
          find /c/ProgramData/chocolatey -name "windres.exe" 2>/dev/null || true
          find /c/msys64 -name "windres.exe" 2>/dev/null || true
        fi
        
        "$WINDRES" \
          --target=pe-x86-64 \
          -i cmd/patris-export/patris-export.rc \
          -o cmd/patris-export/patris-export_windows_amd64.syso \
          -O coff
        
        echo "Resource file compiled successfully:"
        ls -lh cmd/patris-export/patris-export_windows_amd64.syso
    
    - name: Build Windows executable
      shell: bash
      run: |
        mkdir -p build
        
        export CGO_ENABLED=1
        export CGO_CFLAGS="-IC:/pxlib-install/include"
        export CGO_LDFLAGS="-LC:/pxlib-install/lib"
        
        # Get version info
        VERSION="1.0.0"
        BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        
        go build \
          -ldflags "-X main.Version=${VERSION} -X main.BuildDate=${BUILD_DATE}" \
          -o build/patris-export-windows-amd64.exe \
          ./cmd/patris-export
        
        echo "Build complete:"
        ls -lh build/patris-export-windows-amd64.exe
    
    - name: Copy pxlib DLL
      shell: bash
      run: |
        # Copy DLL files to build directory
        if [ -d C:/pxlib-install/bin ]; then
          cp C:/pxlib-install/bin/*.dll build/ 2>/dev/null || true
        fi
        
        # Also check the build directory
        if [ -d C:/pxlib/build ]; then
          find C:/pxlib/build -name "*.dll" -exec cp {} build/ \; 2>/dev/null || true
        fi
        
        echo "Build directory contents:"
        ls -la build/
    
    - name: Test Windows executable
      shell: bash
      run: |
        cd build
        
        # Test the executable can read the test database
        echo "Testing Windows executable with kala.db..."
        ./patris-export-windows-amd64.exe info ../testdata/kala.db || {
          echo "ERROR: Windows executable failed to read database!"
          exit 1
        }
        
        # Verify it reports the correct number of records (use sed for portability, avoid grep -P locale issues)
        RECORD_COUNT=$(./patris-export-windows-amd64.exe info ../testdata/kala.db 2>/dev/null | grep 'Records:' | sed 's/.*Records:[[:space:]]*\([0-9]*\).*/\1/' || echo "0")
        echo "Windows build reports $RECORD_COUNT records"
        
        if [ "$RECORD_COUNT" -eq "0" ]; then
          echo "ERROR: Windows build reports 0 records - CGO/pxlib not working!"
          exit 1
        elif [ "$RECORD_COUNT" -ne "354" ]; then
          echo "WARNING: Expected 354 records but got $RECORD_COUNT"
          # Don't fail, just warn
        else
          echo "âœ… Windows build correctly reports 354 records"
        fi
    
    - name: Verify version information
      shell: pwsh
      run: |
        # Use PowerShell to check the version info in the exe
        Write-Host "Checking version information in executable..."
        
        $fileInfo = Get-Item build/patris-export-windows-amd64.exe
        $versionInfo = $fileInfo.VersionInfo
        
        Write-Host "File Version: $($versionInfo.FileVersion)"
        Write-Host "Product Version: $($versionInfo.ProductVersion)"
        Write-Host "Product Name: $($versionInfo.ProductName)"
        Write-Host "File Description: $($versionInfo.FileDescription)"
        Write-Host "Company Name: $($versionInfo.CompanyName)"
        
        if ([string]::IsNullOrEmpty($versionInfo.FileVersion)) {
          Write-Host "ERROR: No version information found in executable!"
          throw "No version information found in executable!"
        } else {
          Write-Host "âœ… Version information successfully embedded"
        }
        
        # Check DLL version info if it exists
        $dllFiles = Get-ChildItem build/*.dll -ErrorAction SilentlyContinue
        foreach ($dll in $dllFiles) {
          Write-Host "`nChecking version info for $($dll.Name)..."
          $dllVersionInfo = $dll.VersionInfo
          Write-Host "  File Version: $($dllVersionInfo.FileVersion)"
          Write-Host "  Product Version: $($dllVersionInfo.ProductVersion)"
          
          if ([string]::IsNullOrEmpty($dllVersionInfo.FileVersion)) {
            Write-Host "  WARNING: No version information in DLL"
          }
        }
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      id: upload-windows
      with:
        name: patris-export-windows-mingw-amd64
        path: |
          build/patris-export-windows-amd64.exe
          build/*.dll
    
    - name: Generate build summary
      shell: bash
      run: |
        echo "# ðŸªŸ Windows Build Summary (Native MinGW)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get build details for executable
        EXE_FILE="build/patris-export-windows-amd64.exe"
        EXE_SIZE=$(stat -c%s "$EXE_FILE" 2>/dev/null || stat -f%z "$EXE_FILE")
        EXE_SIZE_MB=$(echo "scale=2; $EXE_SIZE / 1048576" | bc)
        EXE_SHA256=$(sha256sum "$EXE_FILE" 2>/dev/null | awk '{print $1}' || shasum -a 256 "$EXE_FILE" | awk '{print $1}')
        BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        # Calculate artifact expiration (90 days from now by default)
        EXPIRY_DATE=$(date -u -d "+90 days" +'%Y-%m-%d' 2>/dev/null || date -u -v+90d +'%Y-%m-%d')
        
        echo "### ðŸŽ¯ Main Executable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“„ Executable | \`patris-export-windows-amd64.exe\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build Date | $BUILD_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¢ Version | \`1.0.0\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ File Size | $EXE_SIZE_MB MB ($EXE_SIZE bytes) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” SHA-256 Hash | \`$EXE_SHA256\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List DLL files if any
        if ls build/*.dll 1> /dev/null 2>&1; then
          echo "### ðŸ“š Included DLL Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | SHA-256 Hash |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------------|" >> $GITHUB_STEP_SUMMARY
          
          for dll in build/*.dll; do
            if [ -f "$dll" ]; then
              DLL_NAME=$(basename "$dll")
              DLL_SIZE=$(stat -c%s "$dll" 2>/dev/null || stat -f%z "$dll")
              DLL_SIZE_KB=$(echo "scale=2; $DLL_SIZE / 1024" | bc)
              DLL_SHA256=$(sha256sum "$dll" 2>/dev/null | awk '{print $1}' || shasum -a 256 "$dll" | awk '{print $1}')
              echo "| \`$DLL_NAME\` | ${DLL_SIZE_KB} KB | \`$DLL_SHA256\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Calculate total artifact size
        TOTAL_SIZE=0
        for file in build/*.exe build/*.dll; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            TOTAL_SIZE=$((TOTAL_SIZE + FILE_SIZE))
          fi
        done
        TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1048576" | bc)
        
        echo "### ðŸ“¦ Artifact Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Artifact Name | \`patris-export-windows-mingw-amd64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total Artifact Size | $TOTAL_SIZE_MB MB ($TOTAL_SIZE bytes) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¥ Download URL | [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| â° Expires On | $EXPIRY_DATE |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY
